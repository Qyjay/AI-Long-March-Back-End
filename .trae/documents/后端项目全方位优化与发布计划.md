## 目标与范围
- 将后端整理为可复用、可部署、可测试的标准化 FastAPI 项目
- 保持现有接口能力（节点/路线/进度、聊天/RAG、健康检查），统一入口与结构
- 消除硬编码密钥/连接、规范依赖、提供容器与CI，准备GitHub发布所需的文档与示例

## 现状要点与问题
- 两套入口与聊天实现并存（`App/main.py` 与 `app.py`），结构不统一
- 数据库与API密钥硬编码，未使用 `.env` 与配置管理
- 日志多为 `print`，错误处理分散，CORS全开放且不可配置
- 直连 `psycopg2` 与 `SQLAlchemy` 并存，迁移工具 `alembic` 未落地
- RAG 两套（DashScope 文档/FAISS 与 Ollama JSON/FAISS）缺少统一选择与复用
- 无容器/CI，测试薄弱，仅有示例脚本

## 目录与架构重构
- 采用分层结构（保持项目根不变）：
  - `app/__init__.py`、`app/main.py`（ASGI入口，统一为一个应用）
  - `app/core/`：`config.py`（Pydantic Settings）、`logging.py`（Loguru集成）、`security.py`（JWT工具，可按需启用）
  - `app/api/`：`routers/`（`chat.py`、`nodes.py`、`routes.py`、`progress.py`、`health.py`）
  - `app/db/`：`session.py`（SQLAlchemy Engine/Session）、`crud.py`（数据库读写封装）
  - `app/models/`（ORM模型），`app/schemas/`（Pydantic请求响应模型）
  - `app/services/`：`rag/`（索引加载/检索，DashScope 与 Ollama 可配置选择）、`sse.py`
  - `data/`（`data.json`、`重走长征路.docx` 等源文件），`faiss_index/`（索引产物，忽略提交）
- 用 `APIRouter` 拆分路由并在 `main.py` 聚合，维持现有路径与行为
- 保留与迁移现有文件的功能代码；新增代码遵循类型标注并添加函数级注释

## 配置与安全治理
- 引入 `pydantic.BaseSettings` + `python-dotenv`：
  - 变量：`DATABASE_URL`、`CORS_ORIGINS`、`LLM_PROVIDER`（`dashscope`/`ollama`）、相关API密钥、`LOG_LEVEL`
  - 提供 `.env.example`（示例）并将 `.env` 加入 `.gitignore`
- CORS 可配置：开发默认 `*`，生产按 `CORS_ORIGINS` 列表
- 秘钥/连接字符串全部从环境读取，删除硬编码
- 预留 JWT 支持（`python-jose`、`passlib` 已在依赖），可通过环境开关启用保护特定路由

## 日志与错误处理
- 统一接入 `loguru`：结构化日志、按级别输出、可选文件轮转
- 增加中间件：请求/响应日志、耗时统计、异常捕获
- 全局异常处理器：`HTTPException`、`RequestValidationError`、通用 `Exception`
- SSE 错误与完成事件统一格式，客户端易于消费

## 数据库与迁移
- 统一使用 `SQLAlchemy` Engine + Session（替换零散 `psycopg2` 直连）
- 引入 `alembic` 流程：初始化、基线、生成迁移、升级/回滚脚本
- 将 `init_database.py` 能力迁移为 Alembic 基线；`import_data.py` 迁移为 CLI/脚本入口，使用会话封装

## RAG 子系统统一
- 抽象接口：`EmbeddingsProvider`、`VectorStore`、`DocumentLoader`
- 通过配置选择 `dashscope` 或 `ollama`：
  - DashScope：沿用 DOCX -> FAISS；密钥来自环境
  - Ollama：沿用 JSON -> FAISS；本地模型地址可配置
- 统一索引目录 `faiss_index/` 与加载逻辑；提供构建索引命令（示例脚本）

## 接口与SSE规范
- 路由分组与标签，完善 `summary`/`description`，OpenAPI 更易读
- 输入输出模型统一在 `schemas/`；返回值加类型与注释
- SSE 使用 `StreamingResponse` 保持现有体验，统一事件字段：`type`、`content`、`meta`

## 测试与质量保障
- 增加 `pytest`：
  - 健康检查、节点列表、路线查询、进度提交的集成测试（TestClient）
  - 聊天接口最小可用测试（模拟嵌入/检索，`unittest.mock`）
- 可选：加入 `ruff/black` 或 `flake8`（若允许新增依赖），否则保持PEP8基本规范

## 交付与运行
- `requirements.txt` 精简与固定版本；按需拆分 `dev`/`prod` 可选
- 提供 `Dockerfile` 与 `docker-compose.yml`：
  - 服务：FastAPI(uvicorn) + Postgres（如需）
  - 环境变量映射与卷（索引与数据）
- Windows 本地运行指南：PowerShell 命令、虚拟环境、环境变量示例

## CI/CD
- GitHub Actions：
  - `python` 工作流：安装依赖、lint（可选）、运行 pytest
  - 构建并（可选）推送容器镜像
  - 保护分支与状态检查

## 文档与仓库治理
- README（用例、运行、配置、API 摘要、SSE 指南、RAG与索引说明）
- `LICENSE`（推荐 MIT）与贡献指南（简单）
- `.gitignore` 更新：`.env`、`faiss_index/`、`__pycache__/`、`*.log` 等
- 保留 `API_Documentation.md`，与 OpenAPI 描述互补

## 执行步骤（可分批PR）
1. 统一入口与目录（不改行为），引入配置管理与日志，去除硬编码
2. 路由拆分与SSE规范化，补充类型与注释
3. 数据库统一与迁移（Alembic），导入/初始化脚本改造
4. RAG 抽象与可切换实现，索引目录与构建流程统一
5. 增加测试、精简依赖、完善 `.gitignore`
6. 增加容器与CI工作流
7. 补充 README/License 与发布清单

— 确认后我将按上述步骤实施，每次变更均添加函数级注释并进行本地验证（含运行或测试），确保不引入回归。