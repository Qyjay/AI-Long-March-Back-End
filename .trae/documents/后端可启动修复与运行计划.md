## 总体目标

* 修复并统一大模型调用为 LangChain `ChatOpenAI`，兼容 `OPENAI_BASE_URL` 与多家服务。

* 确保数据库已从 PostgreSQL 切换到 MySQL 并成功初始化建库/建表。

* 保证服务可在 Windows 11 本地环境成功启动，SSE 流式聊天与数据接口可用。

## 启动前置条件

* 检查目前项目内的 `.env文件是否可以使用`：

  * `DATABASE_URL`：填写你本机 MySQL 的真实账号、口令与库名，例如 `mysql+pymysql://root:你的密码@localhost:3306/app`。

  * `OPENAI_API_KEY` ：已设置

  * `RAG_DOCX_PATH`：确认 `App\重走长征路.docx` 存在。

* 安装依赖：`pip install -r requirements.txt`

## 代码修复与统一（一次性完成）

1. Chat 模块统一改用 LangChain：

   * 在 `App/ChatModel.py`：

     * 新增 `get_llm()`，返回 `ChatOpenAI(model, openai_api_key, base_url, streaming=True)`。

     * 将 `get_client()` 相关的 OpenAI 直连逻辑移除。

     * 调整 `StreamProcessor.process_stream` 以兼容 `AIMessageChunk.content`（同时保留对 `choices[0].delta.content` 的容错处理）。

     * 为新/修改的函数添加函数级注释。

   * 在 `App/api/routers/chat.py`：

     * 三个路由（`/`, `/explanation`, `/qa`, `/poem`）统一改为：`llm = get_llm(); completion = llm.stream([SystemMessage(...), HumanMessage(...)])`。

     * 移除 `get_client().chat.completions.create(...)` 用法，避免不兼容。
2. RAG 初始化稳健性：

   * `App/ChatModel.py` 的 `_create_sample_data` 仅在 DOCX 不存在时调用；修复其写入路径引用错误（避免使用不存在的 `self.json_file_path`）。

   * 保持 FAISS 索引目录可写：`./faiss_index`。
3. MySQL 适配：

   * ORM 中的数组字段统一为 `JSON`（已完成）：`gallery/coordinates/unlocked_nodes/achievements`。

   * 会话层支持自动建库：`CREATE DATABASE IF NOT EXISTS`（已完成）。

## 数据库初始化与数据导入

* 初始化库与表：`python -m App.init_database`

  * 若出现 `Access denied for user 'root'@'localhost'`，请修正 `.env` 中的 `DATABASE_URL` 口令或账号。

* 可选导入节点示例：`python App/import_data.py`

## 启动与验证

* 启动服务：`uvicorn App.main:app --host 0.0.0.0 --port 8000`

* 基本接口验证：

  * `GET /` 返回健康信息。

  * `GET /nodes`、`GET /nodes/{id}`、`GET /route` 正常读取 MySQL。

* SSE 聊天验证：

  * `POST /chat`、`/chat/explanation`、`/chat/poem`、`/chat/qa` 收到 `text/event-stream`，持续输出含 `type=content/start/complete` 的 JSON 行。

## 风险点与处理

* MySQL 口令不匹配：修改 `.env` 后重试初始化脚本。

* 大模型 Key 或 Base URL 未设置：确保设置 `OPENAI_API_KEY` 或 `DASHSCOPE_API_KEY` 与 `OPENAI_BASE_URL`。

* DOCX 缺失：保留默认索引回退逻辑；如缺失则创建默认向量索引并能启动服务。

## 完成后交付

* 服务可启动并返回流式聊天与数据接口。

* 代码包含必要的函数级注释，配置通过 `.env` 管理。

请确认以上计划，我将按此执行修复、运行与验证。
